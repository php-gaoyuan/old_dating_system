<?php	//引入公共模块	require("foundation/module_users.php");	require("foundation/aintegral.php");	require("api/base_support.php");	require("foundation/csmtp.class.php");	require("foundation/asmtp_info.php");	require("foundation/fcontent_format.php");	error_reporting(E_ALL);	//引入语言包	$re_langpackage=new reglp;	$u_langpackage=new userslp;	//语言包引入	$pu_langpackage=new pubtooslp;	$u_langpackage=new userslp;	$limcount=1;//限制每次上传附件数量	//数据表定义区	$t_users=$tablePreStr."users";	$t_online=$tablePreStr."online";	$t_pals_def_sort=$tablePreStr."pals_def_sort";	$t_pals_sort=$tablePreStr."pals_sort";	$t_mypals=$tablePreStr."pals_mine";	$t_invite_code=$tablePreStr."invite_code";	$t_user_activation=$tablePreStr."user_activation";//邮件激活码表	//ajax注册	if(get_argg('ajax')==1){		//p(get_argg("ajax"));		$dbo=new dbex;		dbtarget('r',$dbServs);		//初始化注册数据		$user_name = short_check(get_argp("user_name"));		$user_pws = get_argp("user_password");		$user_email = short_check(get_argp("user_email"));		$birth_day= isset($_POST['birth_day']) ? $_POST['birth_day'] : '';		$birth_month = isset($_POST['birth_month']) ? $_POST['birth_month'] : '';		$birth_year = isset($_POST['birth_year']) ? $_POST['birth_year'] : '';		$user_sex = intval(get_argp("user_sex"));		//开始检查初始数据		check_user_name($dbo);		check_pass();		check_user_email($dbo);		//检查生日		if(empty($birth_year) || empty($birth_month) || empty($birth_day)){			return_json(4, $re_langpackage->re_false_birth);		}		//女号锁定账号		if($user_sex==1){			$is_pass=1;			}else{			$is_pass=0;		}		//初始化头像		$user_ico = ($user_sex==0) ? "skin/$skinUrl/images/d_ico_0_small.gif" : "skin/$skinUrl/images/d_ico_1_small.gif";		$user_big_ico = $user_ico;		//初始化邀请人id		$invite_fromuid=0;		if(get_session('InviteFromUid')){			$invite_fromuid=get_session('InviteFromUid');		}		//初始化ip		$ip = get_client_ip();				//不知道干嘛用的		$sort_rs = api_proxy("pals_sort_def");							//获取推荐人tuid		dbtarget('w',$dbServs);		if(get_argp("tuid")){			$tuid = get_argp("tuid") ? get_argp("tuid") : 0;		}else if(get_argp("uid")){			$tuid = get_argp("uid") ? get_argp("uid") : 0;		}else{			$tuid = isset($_COOKIE['tuid']) ? $_COOKIE['tuid'] : 0;		}		$user_pws = md5($user_pws);		$sql="insert into $t_users 			(user_name, user_pws, user_sex, user_email, user_add_time, user_ico, user_big_ico, user_group, invite_from_uid, is_pass, lastlogin_datetime, birth_year, birth_month, birth_day, login_ip, zhuce_ip, tuid) 			VALUES('$user_name', '$user_pws', $user_sex, '$user_email', '".constant('NOWTIME')."', '$user_ico', '$user_big_ico', '1', $invite_fromuid, $is_pass, '".constant('NOWTIME')."', '$birth_year', '$birth_month', '$birth_day', '{$ip}', '{$ip}', $tuid)";	    //echo $sql;exit;		if(!$dbo->exeUpdate($sql)){			return_json(6,$re_langpackage->re_reg_false);		}		$user_id=mysql_insert_id();		//女性提示锁定		if($user_sex==0){			return_json(6,$re_langpackage->re_gock_u,'index.php');//返回锁定提示			exit();		}		//更新用户上线		$now_time=time();		$sql="insert into $t_online (user_id,user_name,user_sex,user_ico,active_time,hidden) values ($user_id,'$user_name',$user_sex,'$user_ico','$now_time',0)";		$dbo->exeUpdate($sql);		//更新好友排序		foreach($sort_rs as $rs){			$sort_id=$rs['id'];			$sort_name=$rs['name'];			$sql="insert into $t_pals_sort ( name , user_id ) values ( '$sort_name' , $user_id )";			$dbo->exeUpdate($sql);		}		//处理邀请人逻辑		if($invite_fromuid){			increase_integral($dbo,$int_invited,$invite_fromuid);			//取得介绍人的资料信息			$user_row = api_proxy("user_self_by_uid","user_id,user_name,user_sex,user_ico,palsreq_limit",$invite_fromuid);			if($user_row){				$touser_id=$user_row['user_id'];				$touser_name=$user_row['user_name'];				$touser_sex=$user_row['user_sex'];				$touser_ico=$user_row['user_ico'];				$touser_pals_limit=$user_row['palsreq_limit'];			}			if($touser_pals_limit==0){				$sql="insert into $t_mypals (user_id,pals_id,pals_name,pals_sex,add_time,pals_ico,accepted) values ($user_id,$invite_fromuid,'$touser_name','$touser_sex','".constant('NOWTIME')."','$touser_ico',1)";				$dbo->exeUpdate($sql);				set_sess_mypals($invite_fromuid);			}		}		//判断chat_users有没有信息	    $info = $dbo->getRow("select * from chat_users where uid='{$user_id}'");	    if(empty($info)){	        if(empty($user_ico)){	            $user_ico = "skin/default/jooyea/images/d_ico_".$user_sex.".gif";	        }	        //插入数据	        $sql = "INSERT INTO `chat_users` (`uid`,`u_name`,`u_ico`,`last_time`) VALUES ('{$user_id}','{$user_name}','{$user_ico}','".time()."')";	        	        //echo "<pre>";print_r($sql);exit;	        $dbo->exeUpdate($sql);	    }	    unset($info);				set_sess_userid($user_id);		set_sess_usersex($user_sex);		set_sess_username($user_name);		set_sess_userico($user_ico);		set_sess_online('1');		setcookie("IsReged", "Y", time()+(250*3600));		return_json(0, "", "main.php");	}		//检查用户名	function check_user_name(&$dbo){		$user_name = short_check(get_argp("user_name"));		if(strlen($user_name)<4 || strlen($user_name) > 20){			return_json(1,$GLOBALS['re_langpackage']->re_right_name);		}else{			$sql="select user_id from wy_users where user_name='{$user_name}'";			$user_info=$dbo->getRow($sql);			if($user_info){				return_json(1, $GLOBALS['re_langpackage']->re_rep_username);			}		}	}	//检查密码	function check_pass(){		$user_pws = get_argp("user_password");		if(empty($user_pws)){			return_json(2,$GLOBALS['re_langpackage']->re_pass_limit);		}		if(strlen($user_pws)<6){			return_json(2,$GLOBALS['re_langpackage']->re_pass_limit);		}			}	//检查email	function check_user_email(&$dbo){		$user_email=$GLOBALS["user_email"];		if(empty($user_email)){			return_json(3,$GLOBALS['re_langpackage']->re_right_email);		}		$pattern = "/^([0-9A-Za-z\\-_\\.]+)@([0-9a-z]+\\.[a-z]{2,3}(\\.[a-z]{2})?)$/i";		if(!preg_match($pattern, $user_email)){			//p($user_email);			return_json(3,$GLOBALS['re_langpackage']->re_right_email);		}else{			//检查邮箱存在吗			$sql="select user_id from wy_users where user_email='{$user_email}'";			$user_info=$dbo->getRow($sql);			if(!empty($user_info)){				return_json(3, $GLOBALS['re_langpackage']->re_rep_mail);			}		}	}	function return_json($code=0, $msg="", $url=""){		$data=array(			"code"=>$code,			"msg"=>$msg,			"url"=>$url			);		echo json_encode($data);exit;	}	function get_client_ip($type = 0) {	    $type       =  $type ? 1 : 0;	    static $ip  =   NULL;	    if ($ip !== NULL) return $ip[$type];	    if (isset($_SERVER['HTTP_CLIENT_IP'])) {//客户端的ip	        $ip     =   $_SERVER['HTTP_CLIENT_IP'];	    }elseif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {//浏览当前页面的用户计算机的网关	        $arr    =   explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);	        $pos    =   array_search('unknown',$arr);	        if(false !== $pos) unset($arr[$pos]);	        $ip     =   trim($arr[0]);	    }elseif (isset($_SERVER['REMOTE_ADDR'])) {	        $ip     =   $_SERVER['REMOTE_ADDR'];//浏览当前页面的用户计算机的ip地址	    }else{	        $ip=$_SERVER['REMOTE_ADDR'];	    }	    // IP地址合法验证	    $long = sprintf("%u",ip2long($ip));	    $ip   = $long ? array($ip, $long) : array('0.0.0.0', 0);	    return $ip[$type];	}	function p($data){		echo "<pre>";		print_r($data);		exit;	}?>